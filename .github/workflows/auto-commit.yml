name: Auto Commit (Every 5 Minutes - Advanced)

permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  auto-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Generate random commit message
        id: msg
        run: |
          msgs=("Health sync update"
                "Background process refresh"
                "Meta data pulse"
                "Index bump"
                "Routine maintenance"
                "Stability patch"
                "Background keep-alive"
                "Automated integrity update")
          
          RANDOM_MSG=${msgs[$RANDOM % ${#msgs[@]}]}
          echo "message=$RANDOM_MSG" >> $GITHUB_OUTPUT

      - name: Update multiple files
        run: |
          TS="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          SHA_SHORT="$(git rev-parse --short HEAD)"
          BOT_ID="gh-actions-bot"

          # Main update file
          echo "Last update: $TS" > auto_update.txt

          # Heartbeat log file
          echo "Heartbeat: $TS | Bot: $BOT_ID | SHA: $SHA_SHORT" >> heartbeat.log

          # Status JSON file
          echo "{\"timestamp\": \"$TS\", \"sha\": \"$SHA_SHORT\", \"bot\": \"$BOT_ID\"}" > status.json

      - name: Commit changes if any
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git add auto_update.txt heartbeat.log status.json

          if ! git diff --staged --quiet; then
            git commit -m "${{ steps.msg.outputs.message }} | $(date -u) | SHA: $(git rev-parse --short HEAD)"
          fi

      - name: Push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          git push "https://x-access-token:${TOKEN}@github.com/${REPO}.git" "HEAD:refs/heads/${BRANCH}"
